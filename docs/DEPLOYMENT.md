# Deployment Guide

## Prerequisites

- Firebase project configured (see [FIREBASE_SETUP.md](./FIREBASE_SETUP.md))
- Vercel account
- Domain (optional)

## Deploy to Vercel

### Method 1: Vercel CLI (Recommended)

1. Install Vercel CLI:
```bash
npm install -g vercel
```

2. Login to Vercel:
```bash
vercel login
```

3. Deploy:
```bash
vercel
```

4. Follow prompts:
   - Project name: `studytrack`
   - Framework preset: `Next.js`
   - Root directory: `./`

5. Set environment variables:
```bash
vercel env add NEXT_PUBLIC_FIREBASE_API_KEY
vercel env add NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
vercel env add NEXT_PUBLIC_FIREBASE_PROJECT_ID
vercel env add NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET
vercel env add NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID
vercel env add NEXT_PUBLIC_FIREBASE_APP_ID
vercel env add NEXT_PUBLIC_FIREBASE_VAPID_KEY
```

6. Deploy to production:
```bash
vercel --prod
```

### Method 2: Vercel Dashboard

1. Go to [vercel.com/new](https://vercel.com/new)
2. Import your GitHub repository
3. Configure project:
   - Framework: Next.js
   - Root directory: `./`
   - Build command: `npm run build`
   - Output directory: `.next`

4. Add environment variables in Settings > Environment Variables

5. Deploy

## Configure Firebase for Production

### 1. Add Authorized Domain

1. Go to Firebase Console > Authentication > Settings
2. Under "Authorized domains", click "Add domain"
3. Add your Vercel domain (e.g., `studytrack.vercel.app`)
4. If using custom domain, add that too

### 2. Update CORS Settings (if needed)

If using Cloud Functions, configure CORS:

```javascript
const cors = require('cors')({
  origin: [
    'https://studytrack.vercel.app',
    'https://yourdomain.com'
  ]
});
```

## PWA Configuration

### 1. Service Worker

The service worker is automatically generated by `next-pwa`. Ensure it's working:

1. Open your deployed app
2. Open DevTools > Application > Service Workers
3. Verify service worker is registered

### 2. Install Prompt

Test PWA installability:
- Chrome/Edge: Look for install icon in address bar
- Mobile: "Add to Home Screen" in browser menu

### 3. Manifest

Verify manifest is accessible:
- Visit `https://yourdomain.com/manifest.json`
- Check all fields are correct

## Post-Deployment Checks

### Functionality Tests

- [ ] Onboarding flow completes
- [ ] Anonymous auth works
- [ ] Daily check-in submits successfully
- [ ] Verdict displays correctly
- [ ] Micro-action generates
- [ ] Weekly reality check triggers
- [ ] Peer comparison loads (if enabled)
- [ ] Share functionality works
- [ ] PWA installs on mobile

### Performance Tests

Run Lighthouse audit:
```bash
npx lighthouse https://yourdomain.com --view
```

Target scores:
- Performance: 90+
- Accessibility: 90+
- Best Practices: 90+
- SEO: 90+
- PWA: 100

### Security Checks

- [ ] HTTPS enabled
- [ ] Firestore rules enforced
- [ ] Anonymous auth working
- [ ] No sensitive data in client
- [ ] Environment variables not exposed

## Monitoring

### Firebase Console

Monitor in Firebase Console:
- Authentication > Users (track signups)
- Firestore > Data (verify writes)
- Cloud Messaging (track notifications)

### Vercel Analytics

Enable in Vercel Dashboard:
- Project Settings > Analytics
- Track page views, performance

### Error Tracking (Optional)

Add Sentry for error tracking:

```bash
npm install @sentry/nextjs
npx @sentry/wizard@latest -i nextjs
```

## Rollback

If deployment has issues:

### Vercel
```bash
vercel rollback
```

Or in dashboard: Deployments > Previous deployment > Promote to Production

### Firebase
- Firestore: Restore from backup (if enabled)
- Rules: Revert in Rules history tab

## Custom Domain Setup

### 1. Add Domain to Vercel

1. Project Settings > Domains
2. Add your domain
3. Configure DNS:

**For root domain (example.com):**
```
A Record: 76.76.21.21
```

**For subdomain (app.example.com):**
```
CNAME: cname.vercel-dns.com
```

### 2. Update Firebase

Add domain to:
- Authentication > Authorized domains
- Update `NEXT_PUBLIC_APP_URL` environment variable

### 3. SSL Certificate

Vercel automatically provisions SSL via Let's Encrypt. This takes a few minutes.

## Continuous Deployment

### GitHub Integration

1. Connect Vercel to GitHub repository
2. Enable auto-deployments:
   - Production: `main` branch
   - Preview: All other branches

### Deploy on Push

Vercel automatically deploys when you push to GitHub:

```bash
git add .
git commit -m "Update feature"
git push origin main
```

## Scaling

### Firestore Limits (Free Tier)

- 50,000 reads/day
- 20,000 writes/day
- 1 GB storage

Monitor usage in Firebase Console > Usage

### Upgrade Path

When limits reached:
1. Firebase: Upgrade to Blaze plan (pay-as-you-go)
2. Vercel: Upgrade to Pro ($20/month) for better performance

## Backup Strategy

### Firestore Backups

Enable automatic backups:

```bash
# Install gcloud CLI
gcloud auth login

# Schedule daily backups
gcloud firestore backups schedules create \
  --database='(default)' \
  --recurrence=daily \
  --retention=7d
```

### Code Backups

- Primary: GitHub repository
- Mirror: Clone to GitLab/Bitbucket

## Troubleshooting

### Build Fails

Check build logs:
```bash
vercel logs
```

Common issues:
- Missing environment variables
- TypeScript errors
- Dependency conflicts

### Runtime Errors

Check Vercel Function logs:
```bash
vercel logs --follow
```

### Firebase Connection Issues

1. Verify environment variables
2. Check authorized domains
3. Test in Firebase emulator locally

## Cost Estimation

### Firebase (Blaze Plan)

Assuming 1000 daily active users:
- Firestore reads: ~5,000/day = $0.18/month
- Firestore writes: ~2,000/day = $0.18/month
- Auth: Free for <50k MAU
- FCM: Free
- **Total: ~$0.40/month**

### Vercel

- Hobby (Free): Up to 100GB bandwidth
- Pro ($20/month): 1TB bandwidth, better analytics
- Enterprise: Contact sales

For MVP, Hobby plan is sufficient.
